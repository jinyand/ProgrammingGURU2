package com.example.user.finalproject;

import android.content.Context;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.support.v7.app.AppCompatActivity;
import android.os.Bundle;
import android.view.MotionEvent;
import android.view.View;
import android.view.inputmethod.InputMethodManager;
import android.widget.Button;
import android.widget.EditText;
import android.widget.ImageView;
import android.widget.ListView;
import android.widget.ScrollView;
import android.widget.TextView;

import com.example.user.finalproject.adapter.ChatAdapter;
import com.example.user.finalproject.adapter.FoundAdapter;
import com.example.user.finalproject.adapter.LostAdapter;
import com.example.user.finalproject.bean.FCBean;
import com.example.user.finalproject.bean.FoundBean;
import com.example.user.finalproject.bean.LostBean;
import com.example.user.finalproject.bean.SaveBean;
import com.example.user.finalproject.bean.Util;
import com.google.gson.Gson;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

public class PostViewActivity extends AppCompatActivity {

    private ScrollView mScrollView;
    private ListView mLstChat;
    private ChatAdapter mAdapter;
    public static List<FoundBean> mFoundBeanList = new ArrayList<FoundBean>();
    public static List<LostBean> mLostBeanList = new ArrayList<LostBean>();
    private FoundBean mFoundBean;
    private Button mBtnWrite;
    private EditText mEdtWrite;
    private SaveBean mSaveBean;
    private FoundBean mSelFoundBean;
    private LostBean mSelLostBean;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_post_view);

        mSelFoundBean = (FoundBean) getIntent().getSerializableExtra(FoundAdapter.KEY_FOUND_DATA_CLASS);
        mSelLostBean = (LostBean) getIntent().getSerializableExtra(LostAdapter.KEY_LOST_DATA_CLASS);

        mScrollView = findViewById(R.id.scrollView);
        TextView txtTitle = findViewById(R.id.txtTitle);
        TextView txtContent = findViewById(R.id.txtContent);
        ImageView imgPhoto = findViewById(R.id.imgPhoto);

        mLstChat = findViewById(R.id.lstChat);
        mBtnWrite = findViewById(R.id.btnWrite);
        mEdtWrite = findViewById(R.id.edtWrite);


        mBtnWrite.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {

                saveComment();


            }
        });



        if(mSelFoundBean != null) {
            txtTitle.setText(mSelFoundBean.getTitle());
            txtContent.setText(mSelFoundBean.getContent());
        }

        if(mSelFoundBean != null && mSelFoundBean.getImgPath() != null ) {
            Bitmap bitmap = BitmapFactory.decodeFile( mSelFoundBean.getImgPath() );
            imgPhoto.setImageBitmap(bitmap);
        }

        if(mSelLostBean != null) {
            txtTitle.setText(mSelLostBean.getTitle());
            txtContent.setText(mSelLostBean.getContent());
        }

        if(mSelLostBean != null && mSelLostBean.getImgPath() != null ) {
            Bitmap bitmap = BitmapFactory.decodeFile( mSelLostBean.getImgPath() );
            imgPhoto.setImageBitmap(bitmap);
        }



    }

    private void saveComment() {
        //Toast.makeText(this,edtText.getText().toString()+", ",Toast.LENGTH_SHORT).show();
        FCBean fcBean = new FCBean();
        fcBean.setComment(mEdtWrite.getText().toString());

        Gson gson = new Gson();

        String jsonStr = Util.openFile(this, SaveBean.class.getName());
        SaveBean saveBean = gson.fromJson(jsonStr, SaveBean.class);

        FoundBean foundBean = saveBean.getFoundBeanList().get( mSelFoundBean.getSelIdx() );
        foundBean.getFcBeanList().add( fcBean );

        //저장
        String jsonStr2 = gson.toJson(saveBean);
        Util.saveFile(PostViewActivity.this, SaveBean.class.getName(), jsonStr2);

        // Adapter를  생성한다. (Adapter에 리스트 데이터를 넘겨준다.)
        mAdapter = new ChatAdapter(PostViewActivity.this, mSelFoundBean.getSelIdx(), foundBean.getFcBeanList());

        // 최종적으로 Adapter를 ListView에 세팅한다.
        mLstChat.setAdapter(mAdapter);


    }



    @Override
    protected void onResume() {
        super.onResume();

        // Adapter를  생성한다. (Adapter에 리스트 데이터를 넘겨준다.)
        mAdapter = new ChatAdapter(PostViewActivity.this, mSelFoundBean.getSelIdx(), mSelFoundBean.getFcBeanList());

        // 최종적으로 Adapter를 ListView에 세팅한다.
        mLstChat.setAdapter(mAdapter);


        mLstChat.setOnTouchListener(new View.OnTouchListener() {
            @Override
            public boolean onTouch(View v, MotionEvent event) {
                mScrollView.requestDisallowInterceptTouchEvent(true);
                return false;
            }
        });

    }
}
